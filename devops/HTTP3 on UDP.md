## HTTP3 on UDP

看这个吧，https://zhuanlan.zhihu.com/p/32553477

### http/3选择udp

HTTP/3基于QUIC，而QUIC是完全基于UDP的。

`HTTP/3`选择了`UDP`，主要是为了解决对头阻塞问题。它的底层协议，就是大名鼎鼎的`QUIC`，一个运行在传输层（也可以说是应用层）的协议。与`TCP`不同的是，QUIC代码并没有硬编码在操作系统内核中，而是完全运行在用户空间的，默认集成了TLS。

![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/http3-on-udp.jpg)



`连接`这个词，是一个虚拟的概念，在网络中根本就没有连接这么一条线，`连接`只是为了方便你逻辑上的理解。考虑到你现在的客户端服务器是client，服务端是server。那么client和server的数据包交互，就会形成一个`连接`

UDP号称的无连接，其实和TCP的连接没什么两样。唯一的区别是，UDP把数据包发送之后，就什么也不管了，这些信息对端可能收到了，也可能没收到。而当每次都对发送的数据进行ACK确认，它就变成了TCP。

至于这部分确认代码，是放在传输层，还是放在应用层，这都关系不大；但代码是放在操作系统，还是可以独立升级的包中，那关系可就大了。

QUIC是可以独立于操作系统发行的，避免了操作系统缓慢的更新换代问题。QUIC的实现，依然要面对消息的可靠性、滑动窗口、拥塞控制等场景，你可以认为它就是一个TCP，但它与TCP有本质的区别。

这些区别，我们对比一下HTTP的各个版本，在数据传输方面的表现就知道了了。

1. 在比较早的HTTP1.0实现中，如果需要从服务端获取大量资源，会开启N条TCP短链接，并行的获取信息。但由于TCP的三次握手和四次挥手机制，在连接数量增加的时候，整体的代价就变得比较大
2. 在HTTP/1.1中，通过复用长连接，来改善这个情况，但问题是，由于TCP的消息确认机制和顺序机制以及流量控制策略的原因，资源获取必须要排队使用。一个请求，需要等待另外一个请求传输完毕，才能开始
3. HTTP/2采用多路复用，多个资源可以共用一个连接。 但它解决的只是应用层的复用，在TCP的传输上依然是阻塞的，后面的资源需要等待前面的传输完毕才能继续。这就是`队头阻塞现象(Head-of-line blocking)`
4. QUIC抽象出了一个stream（流）的概念，多个流，可以复用一条连接，那么滑动窗口这些概念就不用作用在连接上了，而是作用在stream上。由于UDP只管发送不管成功与否的特性，这些数据包的传输就能够并发执行。协议的server端，会解析并缓存这些数据包，进行组装和整理等。由于抽象出了stream的概念，就使得某个数据包传输失败，只会影响个stream的准确性，而不是整个连接的准确性

### QUIC

https://zhuanlan.zhihu.com/p/32553477

Quic 全称 quick udp internet connection [1]，“快速 UDP 互联网连接”，是由 google 提出的使用 udp 进行多路并发传输的协议。

Quic 相比现在广泛应用的 http2+tcp+tls 协议有如下优势 ：

1. 减少了 TCP 三次握手及 TLS 握手时间。
2. 改进的拥塞控制。
3. 避免队头阻塞的多路复用。
4. 连接迁移。
5. 前向冗余纠错。

QUIC的这些改进：

1. QUIC能够实现TCP协议的所有功能性需求，并集成了TLS，功能上赶超了TCP
2. 一条连接，多个stream并发传输，真正的多路复用，有效解决队头阻塞现象，性能上超越了TCP
3. 减少握手次数，尤其是带TSL传输的握手次数，有更低的握手延迟
4. 由于易于升级，为协议的更新和发展，提供了巨大的想象空间

#### 队头阻塞

队头阻塞主要是 TCP 协议的可靠性机制引入的。TCP 使用序列号来标识数据的顺序，数据必须按照顺序处理，如果前面的数据丢失，后面的数据就算到达了也不会通知应用层来处理。

另外 TLS 协议层面也有一个队头阻塞，因为 TLS 协议都是按照 record 来处理数据的，如果一个 record 中丢失了数据，也会导致整个 record 无法正确处理。

概括来讲，TCP 和 TLS1.2 之前的协议存在着结构性的问题，如果继续在现有的 TCP、TLS 协议之上实现一个全新的应用层协议，依赖于操作系统、中间设备还有用户的支持。部署成本非常高，阻力非常大。

所以 QUIC 协议选择了 UDP，因为 UDP 本身没有连接的概念，不需要三次握手，优化了连接建立的握手延迟，同时在应用程序层面实现了 TCP 的可靠性，TLS 的安全性和 HTTP2 的并发性，只需要用户端和服务端的应用程序支持 QUIC 协议，完全避开了操作系统和中间设备的限制

### 引用：

1. https://juejin.cn/post/6984315270038814727