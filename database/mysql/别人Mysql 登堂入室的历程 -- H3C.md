### 别人Mysql 登堂入室的历程 -- H3C

哈哈哈，为什么有钱的公司都选择Oracle 不用 Mysql

**技术思维**：

用省钱的东西，有问题我搞定，省下的钱分给我，锅我背。

**领导思维**：

你如果不花钱，说明你没有价值，钱花得越多，你的部门越重要、

领导的想法是这项目花了多少钱？什么不要钱？先扔一边我们做另一个，大不了重新来，反正不要钱……那项目花了多少？几几千万！？投入没有产出上边查出来怎么办，再坚持坚持吧。

典型的小王子投入现象

**现实真像**：

技术产品选型, 得综合考虑人力成本, 部署成本, 维护成本及风险成本..

不用时代最好的产品，出了锅，个人背不起。

背锅也不一定就是找谁来负责，而是决定一件事情的性质。如果用mysql，如果出了问题，就说明技术人员水平不行，决策者眼光不行，你们这些人能力不行；选用oracle，出了问题，说明大家都尽力了，用了最好的产品，最好的技术，但还是遇到了困难，这是时代的问题，跟个人无关。

> 8月份，我司核心系统的sybase数据库挂了，严重影响到了经营，受影响的资金每天上亿，甚至受到省政府约谈，分公司、总公司的数据库高手都束手无策，SAP（sybase被SAP收购了）派来了全球顶级专家，传说中国内Sybase四大金刚来了仨。通宵干了一个通宵，真是跪着修好的。。。。商业数据库的价值不在于软件本身，要知道数据无价... ...

除了Oracle的功能和性能确实厉害之外，Oracle有一整套的技术栈和产品，还有专业背锅和解决问题的技术团队。
互联网企业则都是MySQl或者PostgraSQL，因为它们的数据相对没那么重要，另外自己又具有实力足够的技术团队，而这也是传统企业不具备的。

大佬实例：

让有实际经验的来给你讲讲，百度得到的都没什么用。

MSDBA认证，Oracle终生拥护者萝魏紫给你解释下这个问题。

关系型数据库三大，MYSQL，MSSQL，oracle为什么Oracle卖4倍贵，还有很多公司不同MYSQL？为什么MSSQL比MYSQL 企业版贵3倍，还有很多公司不用MYSQL，为什么MYSQL有开源版还有很多公司要用企业版？

第一，服务。

我有一个项目，用的oracle的RAC。我怀疑数据库有问题。一个电话过去。Oracle派一个团队过来，4个人，驻场一个月，调试，测试，出报告。给我把哪些配置配错，哪些配置可以优化，哪些工具可以用来继续监测，讲得清清楚楚。连不是Oracle的问题，都顺手提出来了。

我还有一个项目，用的MSSQL SEVER AG。我怀疑数据库有问题。电话是不接的。要上网填ticket，然后客服打给你，这种客服你懂的，P用都没有。然后一路升级，到一半，发现你的Window没有打全patch，直接postpone，直到你打全patch再说。我只好请Boss调了自己公司其他部门的Wintel 服务团队过来帮忙看，解决了。

MYSQL我没用过企业版，我帮几个朋友调试过他们自己的库。除了满大街查google，还能做啥？要是你一查百度，完了，漫天中文ctrl+c ctrl+v 的blog，前言不搭后语。

第二，健壮性。

Oracle你以为他只是数据库？他卖exadata，整体数据库跑在上面。就算他单独卖的数据库，他的HA集群是自己做的。我十多年用过几百台OracleHA，就没见过所有节点挂掉的。RAC的切换非常快，毫秒级别。而MSSQL的集群，我真实看到过AG内切换所有节点下线几秒钟。而MYSQL集群？你能像阿里那样开发大量持久化中间件？不能的话，我有一个解决方案。定期带服务器去庙里烧烧香。

第三，功能性。

Oracle三大工具，AWR，ADDM, ASH report, 谁用谁知道，用了都说好。MSSQL 的trace file你要看？对不起，先装个MSSQL客户端。装了你也看不懂，完美符合MS系所有的习惯。要不是找到一个微软内部用的自动分析工具，我是绝对不看trace file的。MYSQL 听说有个enterprise monitor，不过没用过。开源版大概只能看看服务器日志，或者装zabbix。。。。



我认为要掌握的：

* 了解数据库系统原理
* 常用SQL
* 索引设置和优化
* 锁
* 高可用的实现与保证：binlog，redo，undo，表空间
* 事务：undo，mvcc
* 分布式事务

数据库，可以成分成几个底层核心知识：

* 磁盘读写优化：cache/buffer
* 存储优化：高可用，空间
* 索引优化：B-TREE
* 并发优化：锁
* 事务优化：acid
* 分布式系统：Pasox、XA、BASE

end



学习专栏之前，自己只是一个 CRUD boy，平时同事间讨论 MySQL 的问题，自己完全搭不上话，因为对 MySQL 底层原理完全不懂。对 MySQL 的认知就仅限一点：索引能提高查询效率。但是为什么能提高？不知道！！

现在回想，以前犯过很多错误：
\1. 主键使用 UUID，非自增主键。
\2. 滥用索引，其实可以通过“最左前缀原则”来精减索引。
\3. 不管 SQL 语句是否合理，只要能返回结果集就是好 SQL。
\4. 建表时字段类型拿捏不准。

现在都会反复学习专栏的每一篇文章，每次学习都有不一样的收获。
第一次可能是：喔，原来有这么个知识点，但对它的实现原理一知半解。
第二次却是：对它的实现原理有了更深的认识，加强对知识的理解，基本会形成一个比较清晰的逻辑。
第三次是，MySQL 的这种实现原理，是为了解决什么问题等等。

现在感觉有点“走火入魔”了，以前执行查询语句，关注的多久能返回结果集。
现在关注的却是：连接器、分析器、优化器、执行器和 InnoDB 引擎。
连接成功后，获取我的权限，查询缓存，命中缓存直接返回，否则进行后续的操作。（记得老师留言区回复过：连接器取权限，执行器用权限。而编写留言到这产生了一个疑问：查询缓存前，应该会校验权限，所以连接器也会用权限？）
分析器阶段进行词法分析，解析关键字，字段名，表名等。语法分析判断语法是否正确。（记得第一篇《基础架构》留言提到语义分析，今晚要找资料学习下）。
优化器阶段生成执行计划，选择索引（这时会怀疑 MySQL 选择的索引是否最优），能否使用索引下推和覆盖索引减少回表查询，提高性能。
执行器阶段调用引擎接口查询数据，Server 层要啥，引擎给啥，InnoDB 只给必要的值。
查询结束后，返回结果集，并将结果集放入查询缓存。

更新语句的关注点是隔离性，视图，MVCC，回滚日志，redo log，binlog，两阶段提交等。
写业务代码时，会考虑事务内的 SQL 语句，能否调整 SQL 语句的顺序，减少更新表时行锁对性能的影响。
在建表的时，会反复推敲这个索引是否合理。使用普通索引还是唯一索引更为合适。能否通过“最左前缀原则”来减少创建索引的个数。如果索引字段的类型是字符串并长度太长，如何优化使用前缀索引，减少空间占用，提高查询性能。

学习专栏后，基本上涉及到 MySQL 的内容，这些知识点都会浮现在脑海中。昨天还差点应用这些知识，帮同事优化他的 SQL 语句。昨天跟往常一样，当写代码写累了，就跑到同事那溜达溜达。
他正在线上的备库测试查询百万数据要多久，另一位同事建议他使用 force index 强制索引，这次执行 5 秒，再执行零点几秒。
他惊乎，为啥这次这么快。我说，这次查了缓存。我还想帮他看看 SQL 语句，是否 MySQL 选择错了索引，导致使用 force index 显式指定索引。说不定使用 order by field 就解决了呢，哈哈哈哈。后面有事，没有继续跟进他这问题了。

非常感恩，跟着老师学习，让我体会到了学习是一件自然而又充满魅力的事情，也让我从一个基础不牢固的小白，一步步地充实了自己的知识库，另外老师非常尽责，经常半夜回复答疑，希望老师保重身体。谢谢！！