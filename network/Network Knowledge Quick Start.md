## Network Knowledge Quick Start

### 基础名称

#### 服务器背板图

啧啧啧，没去机房看过真的感受不到那这扑面而来的通透。

一个2U的服务器一般插有两个网卡，一个网卡有4个口，两个万兆光口两个千兆电口，然后一个类型网络（业务、存储或管理）要接在两个网卡上面的不同端口，在做bond-1(active-backup)实现网卡的高可用。

> 2U服务器除了可以插两个网卡，还有自带的一个带外口和四个千兆电口。

2U的服务器就那么厚，插两个网卡就没地方了

![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/one-NIC-card-multi-port.png)

#### 电口

电口也就是我们常说的网线接口（RJ45），电口接入的是网线，一般速率为10/100/1000M和10G。

 **电口**是相对光口来讲的，是指防火器的物理特性，主要指铜缆，包括普通的网线和射频同轴电缆，是处理的电信号。目前使用普遍的网络接口有百兆电口和千兆电口等。简单来说，电口就是普通的双绞线（Twirst Pair）接口，一般速率为10M或者100M，部分支持1000M.电口的最远距离为100米。电口的线缆上传输的是电信号，例如高电平（代表1），低电平（代表0）。

##### 万兆电口淘汰原因...

测评表略

选择SFP+，可以带来更低的功耗，更低的延时，同时DAC线的成本也并不高。

选择10Gbase-T则可以和传统100M/1G兼容。

在大规模部署的情况下，SFP+确实具有明显的优势。

企业环境里下：

1. 万兆电处于要被淘汰的状态。可选择的交换机不多。
2. 光缆传输不受电磁干扰，在机房环境中工作更稳定。
3. 光纤传输距离远胜于双绞线网线，电口是采用铜缆进行传输的，传输距离不超过100米。

6类线粗，水晶头比LC模块大，当一个48口交换机接满电口时，手根本放不进去，以后想调整线很难...

#### 光口

**光纤接口**是用来连接光纤线缆的物理接口。其原理是利用了光从光密介质进入光疏介质从而发生了全反射。通常有SC、ST、FC等几种类型，它们由日本NTT公司开.光口的线缆上传输的是光信号.

以光为信息载体，利用光纤传输携带信息的光波，以达到通信的目的。

##### 光纤传输原理

光的全反射原理，为以后的光纤传输信号奠定了基础。

> 把传输信息转变成光信号，然后利用光的全反射不断传播。全反射避免折射时，光信号的丢失？
>
> 光射到两种介质的分界面上时，一部分光进入到另一种介质中去，光的传播方向发生改变的现象叫做光的折射．

光在不同物质中的传播速度是不一样的，所以从一种物质射到另一种物质时，两种物质的交界处会发生折射和反射，而且折射光的角度会随入射光的角度变化而变化，当入射光的角度达到或者超过某一角度时，折射光会消失，入射光全部被反射回来，这就是光的全反射。

**利用全反射可以改变光的传输路径即将直线传播的光变成曲线等传播线路。**

![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/全反射传播.jpg)

![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/全反射传播-2.jpg)



在发射端首先把要传输的信息（如话音）变成电信号，然后通过激光器发射到激光束上，光的强度会随电信号的频率一起变化，并通过光纤发射出去，在接收端，检测器受到光信号后把它变成电信号，经过处理后恢复原信息。

　　光纤通信系统的基本组成：光发送机，中继器（放大光信号），光接受机，光纤，如图

![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/光纤传播.jpg)

##### 光纤

光纤是光导纤维的简称，由玻璃或塑料制成。

光纤是一种传输工具，就如同一根细细的塑料丝，很细的光纤会被封装在塑料套中，用作长距离的信息传递。所以光缆是包含光纤的。

光纤一般由纤芯，包层和涂覆层组成，纤芯完成信号的传输，包层与纤芯的折射率不同，将光信号封闭在纤芯中传输并起到了，保护纤芯的作用。

##### 光缆

光缆是由一定数量的光纤组成缆芯，外面包裹有护套和保护层，用于通讯，远距离大容量信息传输。

![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/光缆.jpg)

##### 中继器

光信号就是在光纤内经过一次次的折射传输到终点的，光信号在一次次折射后会分散或者衰减，就需要把光信号每50公里放大一次。

当光从光纤的一端射入，从另一端射出时，光的强度会减弱。光信号通过光纤传播后，光能量损耗了一部分，这说明是光纤中的某些物质或某种原因，阻挡了光信号的通过。

所谓损耗，是指光纤每单位长度上的衰减，单位为dB/km，光纤损耗的高低直接影响着光纤的传输距离和中继站间隔距离。因此，要想使光信号畅通无阻的传输，就必须降低光纤的损耗。

##### 光模块

光口的类型选择对应的光模块，目前市面上常见的有1.25G SFP光模块、10G SFP+ 光模块、25G SFP28 光模块、40G QSFP+ 光模块、100G QSFP28 光模块等，光模块常见的接口类型为LC、SC和MPO接口。



![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/LC-SC.jpg)



##### 单模

单模光纤，光沿着一条路径传播，单模光纤跳线的护套一般是黄色的，单模光纤的传输距离不低于5km，一般用于远程通信。

**激光光源**接近于单一模式，所以通常用于单模光纤。

![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/单模光纤.png)



##### 多模

多模光纤中，光在多条路径中传播。多模一般是橙色或者所谓的水绿色（就是介于蓝色和绿色之间的颜色）；纤芯直径方面，多模的一般情况下要略粗一些。多模光纤只能够达到2km左右，适用于建筑物内或者校园里的短距离通信。

**led光源**较为分散，可以产生多种模式的光，所以多用于多模光纤。

![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/多模光纤.jpg)

如果距离不到几英里，多模光纤将工作良好，传输系统的成本（发射器和接收器）将在3300元至5300元不等。如果被覆盖的距离超过6-10公里，应选择但由于激光二极管的成本增加，传输系统的成本通常会超过6700元。

#### HDM:带外

Hardware Device Management，硬件设备管理，是服务器出厂时内置的软硬件统一管理系统。HDM支持智能部署、智能调优、智能安全、智能运维等功能，为服务器提供全方位的管理、诊断和监控。这种管理系统在业界统称为BMC，Baseboard Management Controller，基板管理控制器。

![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/HDM.jpg)



#### LAN

LAN，全称Local Area Network，中文名叫做**局域网**。

> 通过局域网，传输速度很快，几乎只受网线带宽的限制，但是往往会受到距离的限制，而且十分安全--

具体到路由器，我们一般组网，都是组建的LAN网络，用户在局域网里通信、传输文件。

> 一般路由器的LAN口会图上颜色和WAN口区分，一般LAN口数目会多于WAN口。

其获取到的是内部IP，LAN 内部是交换机。我们可以不连接 WAN 口，把路由器当做普通交换机来使用。

一般用到的LAN的场景：

1，接电脑的网线，需要插到路由器的LAN口。

2，二级路由，一般都是从上级路由的LAN口接线。

#### WAN

WAN，全称Wide Area Network，中文名叫做广域网。

Wide Area Network主要用于实现局域网的远程互连、远距离计算机之间的数据通信及更大范围的资源共享。

WAN是一种跨越大的、地域性的计算机网络的集合。通常跨越省、市，甚至一个国家。广域网包括大大小小不同的子网，子网可以是局域网，也可以是小型的广域网。

WAN：接外部 IP 地址用，通常指的是出口，转发来自内部 LAN 接口的 IP 数据包。

基本每个路由器都有WAN口，当然也有路由猫这种特例。

> 一般路由器都会有一个WAN口，也有多个WAN口的路由。

WAN的应用场景：

1，从猫引出的来网线，要插到路由器的WAN口。

2，二级路由，上级网线插到二级路由的WAN口。

##### 广域网误区

我一直以为广域网，就是一个”外网“即一定会接到外网核心或者外网边界交换机上。

直到看到了下面这张图....广域网接入区是接在内网核心交换机的。

原来，XX银行这边对内网定义是其他地市银行局点或者其他数据地市的数据中心接入区域，都算是内网。由于是跨城市的接入，肯定是广域网了....但是它们都属于银行自身的业务范围所以接入的是**内网核心交换机**而不是外网核心交换机。

> 广域网，传输速度较快且安全系数也很高，但是缺点是费用会很高，这个往往是子公司和母公司之间会采取的手段。

![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/广域网.png)



#### WLAN

WLAN，全称Wireless LAN, 无线局域网。

和LAN不同，WLAN的数据通过电磁波传输，也就是常说的空气传输。WLAN 利用电磁波在空气中发送和接受数据，而无需线缆介质。

WLAN 使用 ISM (Industrial、Scientific、Medical) 无线电广播频段通信。WLAN 的 802.11a 标准使用 5 GHz 频段，支持的最大速度为 54 Mbps，而 802.11b 和 802.11g 标准使用 2.4 GHz 频段，分别支持最大 11 Mbps 和 54 Mbps 的速度。最新的11AC已经达到竟然的1.3Gbps。

##### WiFi

应用 WLAN 的实现协议有很多，其中最为著名也是应用最为广泛的当属无线保真技 术——Wi-Fi，它实际上提供了一种能够将各种终端都使用无线进行互联的技术， 为用户屏蔽了各种终端之间的差异性。 在实际应用中，WLAN 的接入方式很简单，以家庭 WLAN 为例，只需一个无线 接入设备-路由器，一个具备无线功能的计算机或终端（手机或 PAD），没有无线 功能的计算机只需外插一个无线网卡即可。

Wireless Fidelity 基于IEEE 802.11b标准的无线局域网, 简单来说就是wlan的一部分，但随着WiFi的普及，很多人也把WiFi与WLAN等同。

#### VLAN

虚拟局域网(Virtual Local Area Network，VLAN)
虚拟局域网( VLAN )，是指网络中的站点不拘泥于所处的物理位置，根据需要灵活划分不同的逻辑子网中的一种网络技术。

每一个VLAN分形成一个虚拟的局域网络，共享一个单独的广播域。

交换机通常会使用**基于端口划分 VLAN** 的方法。在交换机上手动配置，绑定交换机端口和 VLAN ID 的关系。

##### 管理VLAN

管理VLAN是指，负责传输通过CAPWAP隧道转发的报文，包括管理报文和通过CAPWAP隧道转发的业务数据报文。

##### 业务VLAN

业务VLAN负责传输业务数据报文。如果不配置的话，默认业务VLAN为VLAN1。

##### VLAN1

VLAN1是比较特殊的VLAN，标准的三层交换机，为了做到零配置使用，会默认将端口加入VLAN1。

采用零配置，会出现VLAN1的广播域过大的问题，容易在VLAN1内形成泛洪，因此不推荐WLAN网络规划时使用VLAN1作为管理VLAN或者业务VLAN。

#### 冲突域

Collision Domain

以太网是一种基于CSMA/CD（Carrier Sense Multiple Access/Collision Detect，载波侦听多路访问/冲突检测）的共享通讯介质的数据网络通讯技术，当主机数目较多时会导致冲突严重、广播泛滥、性能显著下降甚至使网络不可用等问题。

形象的说，在此方法下每个接入网络的人都有发送消息的权利，但在同一时间只能有一个人占当前的线路，否则会发生混乱，因此每个人需要在发生前进行载波侦听（是否有人正在占线），如果有则需要等待后才可以发送消息。

当两端同时发生冲突时，则会发生冲突检测，会话终止并随机等待一段时间后再开始的判断。

连接在同一导线上的所有工作站的集合，或者说是同一物理网段上所有节点的集合或以太网上竞争同一带宽的节点集合。也就是说，用Hub或者Repeater连接的所有节点可以被认为是在同一个冲突域内，它不会划分冲突域。由于广播域被认为是OSI中的第二层概念，所以像Hub和交换机等第一，第二层设备连接的节点被认为都是在同一个广播域。

##### LAN and 冲突域

通过路由器/交换机（三层交换机）实现LAN互联可以解决冲突（Collision）严重的问题。

一组与同一条物理介质相连的设备，其中任何两台设备同时访问该介质都将导致冲突，冲突域中同一时间内只有一台机器能够发送数据。

#### ARP

arp没有跨网段的说法.ARP工作在一个广播域，负责二层寻址而且是在广播网络（对于非广播网络，是没有ARP，比如ATM网络）。它完成了硬件MAC地址和IP之间的翻译。

R3的37.1.1.1 ping R4的38.1.1.1，要封装二层的时候，发现没有38.1.1.1对应的MAC地址，先把目的IP和本出接口IP与运算，发现不同网段，就去找路由表，发现路由表没有路由，于是直接丢弃！

#### MAC 表

在初始状态下，交换机的 MAC 地址表是空的，不包含任何条目。当交换机的某个端口接收到一个数据帧时，它就会将这个数据帧的源 MAC 地址、接收数据帧的端口号作为一个条目保存在自己的 MAC 地址表中，同时在接收到这个数据帧时重置这个条目的老化计时器时间。这就是交换机自动添加 MAC 地址表条目的方式。

在新增这一条 MAC 地址条目后，如果交换机再次从同一个端口收到相同 MAC 地址为源 MAC 地址的数据帧时，交换机就会**更新**这个条目的老化计时器，确保活跃的的条目不会老化。但是如果在老化时间内都没收到匹配这个条目的数据帧，交换机就会将这个老化的条目从自己的 MAC 地址表中**删除**。



#### 广播域

网络中一组相互接收广播消息的设备。

二层广播帧覆盖的范围就是广播域；二层单播帧覆盖的范围就是冲突域。

第一层设备如集线器，与之连接的所有设备都属于同一个冲突域和同一个广播域；

第二层设备如交换机和网桥，将网络划分成多个网段，每个网段是一个独立的冲突域，但是相连的所有设备是一个广播域，交换机的每个端口就是一个冲突域；
第三层设备如路由器，将网络划分为多个冲突域和广播域。

##### 广播 and 泛洪:christmas_tree:

 **广播**：向局域网内所有设备发送数据。只有全 1 的 MAC 地址为广播 MAC 地址，即 `FF-FF-FF-FF-FF-FF` 。

 **泛洪**：将某个端口收到的数据从除该端口之外的所有端口发送出去。泛洪操作广播的是普通数据帧而不是广播帧。

交换机上划分了多个 VLAN 时，当交换机接收到一个目的 MAC 地址不存在于自己 MAC 地址表中的单播数据帧时，只会将这个数据帧在相同 VLAN 的端口进行**泛洪**。

#### LLDP

LLDP（Link Layer Discovery Protocol，链路层发现协议）就是用于这个目的的协议。LLDP定义在802.1ab中,它是一个二层协议，它提供了一种标准的链路层发现方式。LLDP协议使得接入网络的一台设备可以将其主要的能力，管理地址，设备标识，接口标识等信息发送给接入同一个局域网络的其它设备。
在vxlan-overlay中，回用到这个协议。

#### BUM

BUM(broadcast&unknown-unicast&multicast,广播&未知单播&组播)

#### ARP/ND

ND： Neighbor Discovery

ARP： Address Resolution Protocol

邻居发现协议NDP（Neighbor Discovery Protocol）是IPv6协议体系中一个重要的基础协议。邻居发现协议替代了IPv4的ARP（Address Resolution Protocol）和ICMP路由器发现（Router Discovery），它定义了使用ICMPv6报文实现地址解析，跟踪邻居状态，重复地址检测，路由器发现以及重定向等功能。

#### CT

Communication Technology

>  IT, Information Technology
>
> IT业和CT业的壁垒越来越不明显，现在已经形成了一个新的行业–ICT业，Information Communication Technology(信息、通信技术)。

CT业被称为电信业，Telecommunication。那是因为最早期的通信都是电报、电话之类的技术，所以也被称为电信技术。

通信业的企业又分为运营商、通信制造业、通信服务支持，一些通信业的施工单位等。

通信业的运营商在国内我们比较熟悉的是中国移动、中国联通、中国电信，现在又多了一个中国广电。

通信业的制造业在中国比较有名气的是三个：华为、中兴、信科。全球范围内，通信业的制造业比较强大的也就是诺基亚、爱立信、华为、中兴这四家了。


#### P、PE、CE

P（Provider）、PE（Provider Edge）、CE（Customer Edge）属于mpls vpn里的概念。在VPN概念中，把整个网络中的路由器分为三类：

**第一类，运营商骨干路由器（P）**

**第二类，运营商边缘路由器（PE）**，PE充当IP VPN接入路由器，即Provide的边缘设备。服务提供商骨干网的边缘路由器，它相当于标签边缘路由器（LER）。PE路由器连接CE路由器和P路由器，是最重要的网络节点。用户的流量通过PE路由器流入用户网络，或者通过PE路由器流到MPLS骨干网。

**第三类，用户边缘路由器（CE）**，服务提供商所连接的用户端路由器，CE路由器通过连接一个或多个PE路由器，为用户提供服务接入。CE路由器通常是一台IP路由器，它与连接的PE路由器建立邻接关系。

**用户站点**：用户端网络的总称，一个用户站点可以通过一条或多条链路连接服务提供商的骨干网络。

#### CR、AR、BR、SR

CR（Core Router，核心路由器）、AR（Access Router，接入路由器）、BR（Broadband Router，汇聚路由器）、SR（Service Router，业务路由器）

一般的ip网络中，根据其拓扑结构，可以把路由器分为边缘路由器BR，接入路由器AR，核心路由器CR。

PE或者AR基本是一个概念，某些运营商称为PE比如联通，某些运营商称为AR比如移动，叫做接入路由器，是CE的直接上级路由器。

所有的软交换站点接入CE都上联到PE或者AR，然后PE或者AR接入运营商的IP骨干网。

三大运营商不同的叫法，实质上是同一个设备作用：

**运营商骨干（核心）路由器---运营商边缘（接入）路由器---用户边缘路由器<=>P（CR）-PE（AR)-CE（BR）**

AR\BR\CR\SR都可以做PE\CE\P设备，一般CR\BR是不会做PE设备的，只做P设备，AR作为PE设备。

除非网络完全建设开，CR\BR在做P设备时兼做PE设备，SR为业务路由器，一般做PE设备。



### Loopback Interface

#### VIP 32 bits mask 

当前主机的路由表...

```bash
Destination 	Gateway	       Genmask	          Use Iface
192.168.247.0	0.0.0.0	       255.255.255.0	   lo
192.168.247.0	0.0.0.0	       255.255.255.0	   eth0
0.0.0.0	       192.168.247.2	0.0.0.0	           eth0
```

（Gateway是0.0.0.0或者*表示目标是本主机所属的网络，不需要路由）
注意：上面的lo是我假设的，为了方便下面的说明，实际在Linux中`route -n`是看不到lo接口的设备的，因为它不对外。

假设当前目标IP 192.168.247.1，**VIP**为192.168.247.100

lo网卡 192.168.247.100 & 255.255.255.0 = 192.168.247.0
eth0网卡 192.168.247.12 & 255.255.255.0 = 192.168.247.0
目标IP地址 192.168.247.1 & 255.255.255.0=192.168.247.0

然后我们需要明白一个事，叫**IP最长匹配原则**。因此不会走最后的默认网关192.168.247.2。而且由于&运算发现目标IP和主机在同一网段内，因此会走上面两条，而且上面两条其实都会匹配成功，但是，**由于是环回网卡一种特殊的网络接口，不与任何实际设备连接，而是完全由软件实现。而且lo环回网卡离内核近，所以在路由表中为第一条，所以数据包会走lo环回接口。**

> 路由最长匹配原则，“能够完全匹配的最长”的，在能够匹配的情况下，越长越精确。

而环回接口另一个特点，就是接收到的数据包又会发回给本机，也就是说回环网卡是自己和自己玩，因此如果走的是环回接口发送数据包，永远也发不出去，因此我们不能让数据包走环回接口，所以需要将掩码设置成255.255.255.255，这样&运算192.168.247.1  ！=192.168.247.100

```bash
Destination   	Gateway	   Genmask	          Use Iface
192.168.247.0	0.0.0.0	   255.255.255.255	   lo
192.168.247.0	0.0.0.0	   255.255.255.0	   eth0
0.0.0.0	     192.168.247.2	0.0.0.0	           eth0
```

因此就不会走我们的环回接口发送数据包，而是走eth0发送数据包。然后通过eth0向交换机广播，获取192.168.247.1地址的MAC地址，将数据包发送过去就完成了相应的过程。

#### 递归路由：一发入魂，666

对于目的地址不是loopback口，下一跳接口是loopback口的报文，路由器会将其丢弃。

啧啧啧，不是递归路由的错误路由，路由器直接丢掉。

R1和R2的互联地址为R1端：10.48.12.1/30，R2端：10.48.12.2/30。R2的Loopback 0地址为10.48.255.2，R2右边的网段为10.112.127.0/24。

递归路由怎么理解？其实简单的说，就是这条路由的下一跳地址，并不在与当前设备直连的下一跳地址。

![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/loopback-routing.jpg)

R1和R2的互联地址为R1端：10.48.12.1/30，R2端：10.48.12.2/30。R2的Loopback 0地址为10.48.255.2，R2右边的网段为10.112.127.0/24。

R1内有一条路由，目标网段是10.112.127.0/24，而下一跳地址是10.48.12.2，则这条路由就不是递归路由了。因为10.48.12.2这个下一跳地址就直接在与R1直连的设备（R2）上。

如果在R1上看到一条路由的下一跳地址是与R1直连设备的互联地址，则这条路由就不是递归路由。通常情况下，通过RIP、EIGRP、OSPF这样的IGP学习过来的路由都不是递归路由。

非递归路由，只需要查找一次路由表。

但如果R1到达10.112.127.0/24的下一跳地址是R2的Loopback 0地址，此时Loopback 0地址并不是与R1直连的互联地址。那么10.112.127.0/24对于R1来说就成了一条递归路由了。

如果碰到递归路由的时候，数据应该怎么走呢？

比如，数据到了R1，要去10.112.127.0/24，但是在R1上，10.112.127.0/24的下一跳地址是R2的Loopback 0地址-10.48.255.2。那么在这个时候，R1就要先找到达10.48.255.2的下一跳，才能把数据发送给10.112.127.0/24

数据要去10.112.127.0/24这个网段，但是这条路由在R1上是递归路由。所以，数据先查找去10.48.255.2的下一跳地址（即10.112.127.0/24的下一跳的下一跳），找到10.48.255.2的下一跳是10.48.12.2。

> 这个例子中VIP只指向了一个IP，如果这个vRouter是个host，而且有两个网卡，这个vip就可以实现灾备了，一个网卡挂了还可以走到另一个网卡。

于是，R1先把数据发送到10.48.12.2，由10.48.12.2再把数据发送到10.48.255.2，再发送到10.112.127.0/24上。

如果R1上，到10.48.255.2的路由不可达，则10.112.127.0/24这条递归路由也无效。**也就是说，递归路由的下一跳地址不可达，则递归路由失效。**

在刚才说的那个例子中，因为R1和R2之间就那么一条链路，所以R1到10.112.127.0/24的路由是不是递归路由，都不会影响到数据流量的走向。再来看下面一个例子，就可以看到递归路由的走向问题了：

![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/loopback-routing-2.jpg)

此时，R1要发送数据去10.112.127.0/24，则需要先到达10.48.255.3（先找到10.48.255.3）的下一跳。从图上来看，R1到达10.48.255.3，可以走R2方向的10.48.12.2，也可以走R4方向的10.48.14.2。那到底是走哪头呢？这个就要看R2和R4传递给R1的，关于10.48.255.3的路由谁的优先级更高了。

所以，在递归路由的情形下，数据的走向实际上是由如何到达它的下一跳地址的走向来决定的。

在BGP的知识点内，就有这么一条：BGP路由的下一跳地址属性（Next-Hop属性）是BGP邻居的更新源地址。因为iBGP邻居通常是用Loopback 地址，所以iBGP的路由也通常是递归路由。虽然教材上说iBGP用Loopback地址做更新源是为了更稳定，但这也不代表iBGP就必须要用Loopback地址做更新源，因为在一些极端的场合下，递归路由可能造成路由环路。

####  loopback 主机网卡双活

添加一个32位掩码的IP地址到Loopback接口：
**ip addr add dev lo 33.33.33.33/32**
再添加两条路由
**ip route add 0.0.0.0/0 via 1.1.1.2 metric 10 src 33.33.33.33
ip route add 0.0.0.0/0 via 2.2.2.2 metric 20 src 33.33.33.33**
然后在其网卡1直连的机器1上配置一条路由：
**route add -host 33.33.33.33 gw 1.1.1.1 (1.1.1.1是网卡1的IP地址)**
然后在其网卡2直连的机器2上配置一条路由：
**route add -host 33.33.33.33 gw 2.2.2.1 (2.2.2.1是网卡2的IP地址)**

> 这就是 递归路由了趴~~

效果是什么？效果就是网卡1或者网卡2由于某种原因down掉了，只要另一个还up，33.33.33.33这个地址就是可达的，同时33.33.33.33也是提供服务的地址。在这个例子中，网卡上配置的1.1.1.1，2.2.2.1这两个IP地址完全是用于IP路由寻址的，而标示主机的33.33.33.33则配置在Loopback接口上。Loopback接口的IP地址被认为只能是最后一跳，因为不能将它用于寻址。


#### 路由器 loopback端口

对于目的地址不是loopback口，下一跳接口是loopback口的报文，路由器会将其丢弃。

如果loopback接口存在、有IP地址，在路由协议中就会将其用作Router ID，这样比较稳定--loopback接口一直都是up的。
如果loopback接口不存在、或者没有IP地址，Router ID就是最高的IP地址，这样就比较危险--只要是物理地址就有可能down掉。
对于CISCO来说，Router ID是不能配置的，对于VRP来说，Router ID可以配置，那麽我们也可以将Loopback接口地址配成Router ID。、

数据包发出时的源地址选择上，按照IP路由逻辑，在没有bind地址的情况下，源地址选择将和下一跳网关执行最长掩码匹配算法来选择。我们不能指望上层都会bind源地址，因此就需要在IP层影响源地址选择算法，否则Loopback接口的地址将永远不会被选中，因为它没有链路层路由，和任何地址都不处在“同一网段”，故而你不能在“该网段”去寻找下一跳。



Loopback接口是虚拟接口，是一种纯软件性质的虚拟接口。任何送到该接口的网络数据报文都会被认为是送往设备自身的。大多数平台都支持使用这种接口来模拟真正的接口。这样做的好处是虚拟接口不会像物理接口那样因为各种因素的影响而导致接口被关闭。事实上，将Loopback接口和其他物理接口相比较，可以发现Loopback接口有以下几条优点：
  1.Loopback接口状态永远是up的，即使没有配置地址。这是它的一个非常重要的特性。
  2.Loopback接口可以配置地址，而且可以配置全1的掩码,可以节省宝贵的地址空间。
  3.Loopback接口不能封装任何链路层协议。

对于目的地址不是loopback口，下一跳接口是loopback口的报文，路由器会将其丢弃。对于CISCO路由器来说，可以配置[no] ip unreachable命令，来设置是[否]发送icmp不可达报文，对于VRP来说，没有这条命令，缺省不发送icmp不可达报文 。

**基于以上所述**，决定了Loopback接口可以广泛应用在各个方面。其中最主要的应用就是：路由器使用loopback接口地址作为该路由器产生的所有IP包的源地址，这样使过滤通信量变得非常简单。

1.在Router ID中的应用
如果loopback接口存在、有IP地址，在路由协议中就会将其用作Router ID，这样比较稳定--loopback接口一直都是up的。
如果loopback接口不存在、或者没有IP地址，Router ID就是最高的IP地址，这样就比较危险--只要是物理地址就有可能down掉。
对于CISCO来说，Router ID是不能配置的，对于VRP来说，Router ID可以配置，那麽我们也可以将Loopback接口地址配成Router ID。

##### 配置BGP loopback

在IBGP配置中使用loopback接口，可以使会话一直进行，即使通往外部的接口关闭了也不会停止。配置举例：
interface loopback 0
ip address 215.17.1.34 255.255.255.255
router bgp 200
neighbor 215.17.1.35 remote-as 200
neighbor update-source loopback 0





### 引用

1. https://zhuanlan.zhihu.com/p/398162417
2. https://blog.csdn.net/qq_29229567/article/details/97813141
3. http://www.mryu.top/notes/311.html
