## 网络基础知识

### 网络概述

* 硬件方面：通过介质（电线、光纤和电磁波等）将网络设备和终端连接起来
* 软件方面：操作系统，应用软件，应用程序互相通讯
* 实现资源共享、信息传递

![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/net-arc.png)

![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/net-concept.jpg)

### 网络演进

* network: 网络，一组相互连接、通讯的设备
* internet: 互联网，多个互联互通的网络
* Internet: 因特网，互联全世界的网络

![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/net-evolution.jpg)

### ISP

Internet Service Providers，因特网服务提供商，向用户提供互联网接入业务、信息服务和增值业务的运营商，如：电信、移动和联调。

![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/net-isp.jpg)

![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/net-isp-service.jpg)

#### ADSL

以前的拨号上网，以前家庭没有路由器和交换机，猫直接直接接到电脑上，利用操作系统拨号上网功能完成网络拨入。

PPPoE，每次拨号入网运营商分配的公网地址都不同。

![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/adsl-ppoe.jpg)

### 网络类型

* PAN：Person Area Network，个域网

* LAN：Local Area network，局域网

* CAN：Campus Area Network，园区网

  典型园区网就是高校和办公园区，也可以称为大型局域网

  ![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/CAN-net.jpg)

* MAN：Metropolitan Area Network，城域网

  某城市/街道

* WAN：Wide Area Network，广域网

  跨地域网，北京到上海

* WLAN：Wireless Local Area Network，无线局域网

  主要是AC和AP的配置，典型就是无线wifi

* WWAN：Wireless Wide Area Network，无线广域网

  典型：手机4G和5G网络

### 网络带宽

bandwidth，单位是bps（bit per second），比特每秒。

硬盘存储是Byte为单位，所以100Mb带宽，理论上在电脑上下载速度最快是`100/8=12.5`MB/s.

### 网络拓扑

Topology，用来描绘网络结构（网络类型、设备类型、设备数量、线缆、带宽、服务、数据走向等）的示意图。

### 网络分层设计

分层思想：将复杂的流程分解为几个功能相对单一的子过程

* 流程更加清晰，复杂问题简单化
* 更容易发现问题并针对性的解决问题

![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/net-layer-tcpip.jpg)

抓包通常是看到4层，因为物理层是光电信号，看不到。

![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/网络分层.jpg)

Frame是整个数据链路层的数据帧

### 单/组/广播

根据目标地址判断，是单播、组播或多播

![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/接口流量类型.jpg)

#### Unicast

![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/unicost.jpg)

![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/unicost-2.jpg)

#### Broadcast

只要广播有域的概念，即广播域

典型使用广播协议：ARP

广播，发送给所属广播域内的所有目标。

MAC地址=`FFFFFFFFFFFF`

IP地址=该网段的广播地址

![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/broadcost-1.jpg)

广播，一对其所在广播域所有。

![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/broadcast-2.jpg)

#### Multicast

典型使用组播协议：OSPF

组播，相当于给特定label的设备发信息。

组播，目标IP地址是D类预留组播地址，MAC地址=`01-00-5E`开头

![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/multicast-1.jpg)

组播和单播一样，可以跨路由器，按照路由表传输。

![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/multicast-2.jpg)

#### 流量接收规则

单播：只有目标MAC相同的机器才会接收单播数据

广播：广播域内所有设备都会收到广播数据，然后根据自身判断是否响应广播包。eg，只有IP相同的设备才会响应广播arp包

组播：

![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/流量接收规则.png)

### 广播和冲突

![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/广播and冲突.jpg)

#### switch Crossbar 

交换机不会出现链路冲突，不存在冲突域

![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/hub-and-switch.jpg)

Crossbar 纵横模型，这是一个开关矩阵，每一个 Crosspoint（交点）都是一个开关，交换机通过控制开关来完成输入到特定输出的转发。一个 Crossbar 模型如下所示。

N个输入和N个输出，相互通信，则每条线都需要有交点即N*N。

![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/switch-fabric-2.png)

《类似围棋棋盘的图》

> 可以脑补手动接线的场景吗，到了Switch Fabric架构，纵横交错的线实现互通。

所以，交换机每个端口都是隔离的一个冲突域

![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/switch-port.jpg)



#### hub single link

HUB（集线器）、冲突和冲突域是很老的设备和概念了，因为很早以前HUB内部只要一条通讯线路，多个设备接到HUB通讯时，就会发生链路冲突。

![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/hub-net-conflict.png)

![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/hub-conflict-demo.png)

#### Router

路由器一个接口一个广播域。

### 网关

Gateway always is default router.

![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/net-gateway.png)

Ethernet网络中网关地址通常是该网段的第一个地址或者最后一个地址，但也可以安装管理员意愿随便配置的。

> 因为Ethernet中需要通过arp广播拿到目标IP的MAC地址，如果网关和主机不在一个网段，会导致拿不到网关MAC从而导致路由下一跳不可达。

eg： 192.168.1.0/25 网关通常是192.168.1.1或者192.168.1.2542

10.240.12.0/26 则网关通常是10.240.12.1或者10.240.12.192

### 为什么三层没有环路

如下，网络拓扑中三层交换机物理连接上存在冗余环状链路，但是却不需要类似STP协议破坏环路呢

![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/三层路由冗余链路.jpg)

这是因为路由协议在生成路由表之前已经通过优先级和度量值的判断选择了最优路径，不会存在环路的情况。即路由协议通过协议本身算法实现了逻辑破环。

![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/路由协议逻辑破环.jpg)



### 大二层网络

大二层网络用解决虚拟机大范围和跨地域的迁移，避免限制在一个小范围的二层网络中（基于STP协议的小POD网络）。

![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/二层网络-迁移vm问题.jpg)

大二层网络架构如下：

![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/大二层网络vm迁移.png)



#### 传统二层网络：阻塞环路

依赖STP协议解决网络拓扑中冗余链路产生的环路问题。

> 避免单链路故障，所以有环路，冗余链路会导致：广播风暴、MAC地址表不稳定、重复帧拷贝。
>
> ![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/stp-环路.jpg)

- 在数据结构中,有一个方法叫做**最小生成树**,有环的我们称为**图**,将图中的环破了,就生成了**树**
- 在计算机网络中,生成树的算法叫做**STP**,全称**Spanning Tree Protocol**
- STP协议通过交换机之间互相比武的方式,最终所有的交换机,环被打破,生成一棵树

STP协议能够很好的解决环路问题,但是也有它的缺点,你能举几个例子吗?

缺点:

* 堵塞多余端口，不具备负载分担能力
* 收敛时间慢，设备通常小于50台
* STP协议为了避免环路，对冗余链路进行阻断，不可避免的导致了链路利用不充分、非最优路径转发的问题

![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/传统二层网络-stp.jpg)



#### 堆叠技术：网络设备厂商

堆叠即网络设备虚拟化技术，本质是天然无环消除破环协议STP的限制。

目前各大网络厂商分别拥有各自的交换机堆叠技术，比如华为的iStack（Intelligent Stack）和CSS、华三的IRF（Intelligent Resilient Framework，智能弹性架构）以及思科的StackWise等等。

堆叠对百分之90的公司都是极好的方案，考虑堆叠是厂家黑盒问题多，但完全可以把堆叠下沉到接入层，上层全跑路由。

构建小型和中型POD数据中心网络可以。

![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/网络设备虚拟化.jpg)

#### TRILL/SPB：网络设备厂商

路由化二层转发技术(IEEE 标准协议，各个网络设备厂商都支持)，将路由协议的逻辑破环引入到二层网络，从而摆脱xSTP协议的束缚。

![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/路由技术引入二层.jpg)

TRILL将路由协议IS-IS的设计思路引入到二层技术中，同时对IS-IS进行了必要的改造，形成TRILL IS-IS协议。在组网方面，TRILL网络的核心设备为RB，众多RB组成TRILL网络。RB之间通过运行TRILL IS-IS协议来感知整个TRILL网络的拓扑，每个RB使用SPF算法生成从自身到TRILL网络中其他RB的路由转发表项，用以完成数据报文的转发。

> RB（Routing Bridge，路由桥）：运行TRILL协议的设备称为RB，也写作RBridge。RB包含传统交换机的所有功能，同时又具有传统路由器的路由功能。

![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/IS-IS-and-trill.jpg)

Trill适用于大型POD网络或整个数据中心网络。

缺点就是造价高，对网络设备要求高，需要支持这个比较新的Trill协议、

#### Overlay：IT厂商

Overlay技术包括：VxLAN（Vmware提出）和 NVGRE（Microsoft提供）。

Overlay对多租户和SDN支持也比较友好。

IT厂商的初衷是，利用自身服务器的计算能力提供虚拟交换机来说实现Overlay网络的解封装，物理承载网络仅负责数据包的转发与传输。这样既可以减少对现有网络架构的改造；还可以减少对网络设备厂商的依赖，把对网络设备的购买需求转变成对高配置服务器的需求。

> Overlay方案承重网络仅需满足基本的交换和转发能力即可。Overlay的解封装由物理服务器上的虚拟交换机来实现。

但是，网络厂商为了市场也推出了支持Overlay的专用网络设备，性能确实比主机Overlay好。

> Overleay的实现分为三种（网络设备厂商和IT厂商的博弈）：
>
> * 主机Overlay：Overlay协议的数据解封装通过服务器的虚拟交换机（OVS/OVN）来实现。由IT厂商服务器实现Overlay，无需改造现有物理承载网络。
> * 网络Overlay：由支持VxLAN或NVGRE的网络设备来作为边缘设备实现Overlay数据的解封装，可以支持任何底层物理设备。网络设备厂商实现Overlay，与IT设备无关。
> * 混合Overlay：它融合了两种Overlay方案的优点，比较灵活。对于性能要求不是太高的网络区域可以使用主机Overlay，对于核心稳定区域可以使用网络Overlay。

![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/大二层-Overlay-2.jpg)

如下是抽象的Overlay隧道网络

![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/大二层-Overlay-1.jpg)

所有VM直连在虚拟二层交换机上，不存在环路问题。

![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/大二层-Overlay-3.jpg)

但是主机Overlay性能没有网络Overlay好，比如大流量k8s集群，会借助ToR设备实现pod的VxLAN封装，从而提升k8s cni插件的网络能力。

### 二层网络跨数据中心互联

#### 传统二层网络互联

缺点：

* 配置复杂
* 带宽利用率低
* 网络部署成本大
* 网络资源消耗高

![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/传统二层网络互联.jpg)

#### 大二层网络互联

VxLAN隧道自动建立-

![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/大二层网络互联.jpg)

### 引用

1. https://github.com/TomorrowWu/interview/blob/master/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE/STP%E5%8D%8F%E8%AE%AE%E7%9A%84%E7%BC%BA%E7%82%B9.md
2. https://e.huawei.com/cn/videolist/networking/dcswitch/2548f5f754a844f9bd0bb17d00f4c5ce
