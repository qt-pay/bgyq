## 交换机-Switch

1. 交换机类型
2. 交换机概念
3. 交换机协议
3. #

有人给我说，网络三板斧：access、trunk和hybird.

### L3 Switch：三层交换机

#### 数据流处理

比如A要给B发送数据，已知目的IP，那么A就用子网掩码取得网络地址，判断目的IP是否与自己在同一网段。

使用IP的设备A------------三层交换机----------------使用IP的设备B

如果在同一网段，但不知道转发数据所需的MAC地址，A就发送一个ARP请求，B返回其MAC地址，A用此MAC封装数据包并发送给交换机，交换机起用二层交换模块，查找MAC地址表，将数据包转发到相应的端口。

如果目的IP地址显示不是同一网段的，那么A要实现和B的通讯，在流缓存条目中没有对应MAC地址条目，就将第一个正常数据包发送向一个缺省网关，这个缺省网关一般在操作系统中已经设好，对应第三层路由模块，所以可见对于不是同一子网的数据，最先在MAC表中放的是缺省网关的MAC地址；然后就由三层路由模块接收到此数据包，查询路由表以确定到达B的路由，将构造一个新的帧头，其中以缺省网关的MAC地址为源MAC地址，以主机B的MAC地址为目的MAC地址。通过一定的识别触发机制，确立主机A与B的MAC地址及转发端口的对应关系，并记录进流缓存条目表，以后的A到B的数据，就直接交由二层交换模块完成。这就通常所说的**一次路由多次转发**。

第三层交换工作在OSI七层网络模型中的第三层即网络层，是利用第三层协议中的IP包的包头信息来对后续数据业务流进行标记，具有同一标记的业务流的后续报文被交换到第二层数据链路层，从而打通源IP地址和目的IP地址之间的一条通路。这条通路经过第二层链路层。有了这条通路，**三层交换机就没有必要每次将接收到的数据包进行拆包来判断路由，而是直接将数据包进行转发，将数据流进行交换。**

第三层交换工作在OSI七层网络模型中的第三层即网络层，是利用第三层协议中的IP包的包头信息来对后续数据业务流进行标记，具有同一标记的业务流的后续报文被交换到第二层数据链路层，从而打通源IP地址和目的IP地址之间的一条通路。这条通路经过第二层链路层。有了这条通路，**三层交换机就没有必要每次将接收到的数据包进行拆包来判断路由，而是直接将数据包进行转发，将数据流进行交换**。

#### 特点

**a、**由硬件结合实现数据的高速转发。

**b、**这就不是简单的二层交换机和路由器的叠加，三层路由模块直接叠加在二层交换的高速背板总线上，突破了传统路由器的接口速率限制，速率可达几十Gbit/s。算上背板带宽，这些是三层交换机性能的两个重要参数。

**c 、**简洁的路由软件使路由过程简化。

**d、**大部分的数据转发，除了必要的路由选择交由路由软件处理，都是又二层模块高速转发，路由软件大多都是经过处理的高效优化软件，并不是简单照搬路由器中的软件。

二层交换机：基于MAC地址
三层交换机：具有VLAN功能 ，交换和路由，基于IP，就是网络。

#### diff with Router

三层交换机虽然也有路由转发功能，但是不能取代路由器，因为它们的基本实现原理不同。

功能区别：

路由器不仅具有路由功能，还提供了交换机端口、硬件防火墙附加功能，其目的是使设备适用面更广、使其更加实用。

三层交换机同时具备了**数据交换**和**路由转发**两种功能，但其主要功能还是**数据交换**；而路由器仅具有路由转发这一种主要功能。

适用场景：

路由器主要是用于不同类型的网络之间。它最主要的功能就是路由转发，解决好各种复杂路由路径网络的连接就是它的最终目的。如局域网与广域网之间的连接、不同协议的网络之间的连接等，优势在于选择最佳路由、负荷分担、链路备份及和其他网络进行路由信息的交换等。另外，为了与各种类型的网络连接，路由器的接口类型非常丰富，而三层交换机则一般仅同类型的局域网接口，非常简单。

交换机在局域网中的主要用途还是**提供快速数据交换功能**，满足局域网数据交换频繁的应用特点。

“转发”区别：

三层交换机通过**硬件执行**数据包交换。三层交换机在对第一个数据包送控制面进行路由查找后，它将会产生一个供数据面查找的MAC地址与IP地址的映射表，当同样的数据流再次通过时，将根据此表查表通过而不是再次送控制面查路由（即“一次路由，多次交换”）。**三层交换机只要第一次会进行源到目的的路由，此后数据都基于该链路传输。**

**路由器也都是硬件转发的，但是每个数据包都要路由，每次源到目标的转发路径都是路由算法给出的最优解。**



### 交换机基础

#### 问题排查

一般来说交换机的转发能力都是ok的，主要排查以下方向。
1、接口下是否有错包，排除单一链路故障；
2、堆叠口下是否有异常；
3、生成树是否异常；
4、可以调整下聚合模式看看；
5、在交换机上下行接口做流统，看下丢报位置在哪里。

#### 交换机类型

##### 核心交换机

https://blog.csdn.net/qq_15350605/article/details/122283363?utm_medium=distribute.pc_relevant.none-task-blog-2~default~baidujs_title~default-0.no_search_link&spm=1001.2101.3001.4242.1&utm_relevant_index=3

##### 网管交换机

网管型交换机就字面上的意思，可以网络管理的交换机，管理方式有三种，可通过串口管理、可通过Web管理、通过网管软件管理。

网管型交换机的数据，会通过简单网络管理协议(SNMP)来实现配置，SNMP协议是目前基于TCP/IP网络使用最广泛的网络管理协议，可以对数据的地址、端口、协议类型、服务等进行过滤，通常还拥有VLAN划分功能。



**端口汇聚**是网管交换机的功能，是将交换机的多个物理端口汇聚为一个逻辑端口，从而实现端口速率叠加和冗余备份。

##### 非网管交换机

非网管交换机，是相对网管型交换机而言的，非网管交换机又称为傻瓜型交换机，简单说就是它对数据是不做直接处理的，插上网线即可。非网管型交换机属于数据链路层设备,可以识别数据包中的MAC地址信息,然后根据MAC地址进行转发,并将这些MAC地址与对应的端口记录在自己内部的一个地址表中。它的优点的就是使用方便即插即用，可以大量串联使用适合PC设备密集度高的地方使用，价格便宜可以节省开支。

泛洪，学习，MAC转发

##### 非网管PoE交换机

PoE交换机供电指的是可以将电力加注在网线上，同一个网线既可以传输数据又可以传输电力。

普通的交换机虽没有PoE供电，但可以用PoE供电器来实现，不一定非要改交换机，PoE供电器与普通交换机连接，就相当于一个PoE交换机了。

https://smb.tp-link.com.cn/service/detail_article_2945.html

##### 虚拟交换机:star2:

虚拟化平台（类似VM vSphere 和 H3C CAS）支持标准虚拟交换机及分布式虚拟交换机。

可以把虚拟交换机，当成一个"二层"可网管的交换机来使用。普通的物理交换机支持的功能与特性，虚拟交换机也支持。组成虚拟化平台物理主机的**物理网卡**，可以"看成"虚拟交换机与物理交换机之间的"**级联线**"。

根据主机物理网卡连接到的物理端口的属性（Access、Trunk、链路聚合），可以在虚拟交换机上，以实现不同的网络功能。



#### 交换机端口

##### POE端口

Power over LAN ，可以供电。

##### Uplink端口/级联

问题： 非网管交换机（交换机又不支持 vlan）提供一个 uplink 口（uplink 口没有 poe 供电）是为了什么？

答：这个口用于和其他交换机通信，不需要 poe。否则用一个 poe 口和其他交换机通信，很浪费。

UPLINK 端口的作用是为了解决网络设备互连时的网线（交叉线和直通线）的使用问题。和有没有网管功能无关。早期的设备端口不支持 AUTO-MDI/MDIX，用错跳线无法通信。

还有部分交换是非标准 POE 供电，插错端口容易烧相连设备端口。而你这个 POE 的傻瓜交换机，设置一个 uplink 估计是因为只做了 7 个端口的 poe，专为监控、带 AP 等用途设计的，只能做上行使用了。

#### 交换机的4种网络结构

##### 级联

最常用的一种组网方式，它通过交换机上的级联口(UpLink)进行连接。级联可以定义为两台或两台以上的交换机通过一定的方式相互连接。根据需要， 多台交换机可以以多种方式进行级联。

在较大的局域网例如园区网 ( 校园网 ) 中，多台交换机按照性能和用途一般形成总线型、树型或星型的级联结构。

需要注意的是交换机不能无限制级联，超过一定数量的交换机进行级联，最终会引起广播风暴，导致网络性能严重下降。

##### 端口聚合

端口聚合将两个设备间多条物理链路捆绑在一起组成一条逻辑链路，从而达到带宽倍增的目的(这条逻辑链路带宽相当于物理链路带宽之和)。

##### 堆叠

堆叠是指将一台以上的交换机组合起来共同工作， 以便在有限的空间内提供尽可能多的端口。

多台交换机经过堆叠形成一个堆叠单元

##### 分层

一般应用于比较复杂的交换机结构中，比如传统的三层架构和Spine-Leaf架构。



#### 背板带宽

https://www.cnblogs.com/liushui-sky/p/14303485.html

交换机背板总线或交换矩阵的总吞吐能力，如同高速公路的设计总宽度。

交换机的背板带宽也叫背板容量，是交换机接口处理器或接口卡和数据总线间所能吞吐的最大数据量。背板带宽标志了交换机总的数据交换能力。

**交换机的交换容量（背板带宽|交换带宽）计算方法为：端口数\*相应端口速率\*2（全双工）。**

例如一台24口百兆交换机交换容量=24\*100\*2=4800Mbit=4.8Gbps

交换机交换容量（背板带宽|交换带宽）和包转发率关系：

**交换容量=包转发速率\*8\*（64＋8＋12）\*2 (全双工)=1344\*包转发速率**

#### 带内 and 带外

​       交换机的管理方式可以分为带内管理和带外管理两种管理模式。所谓带内管 理，是指管理控制信息与数据业务信息通过同一个信道传送。使用带内管理，可以通过交换机的以太网端口对设备进行远程管理配置，目前我们使用的网络管理手段基本都是带内管理。

​    在**带外管理模式**中，网络的管理控制信息与用户数据业务信息在不同的信道传送。带内管理和带外管理的最大区别在于，带内管理的管理控制信息占用业务带宽，其管理方式是通过网络来实施的，当网络中出现故障时，无论是数据传输还是管理控制都无法正常进行，这是带内管理的最大缺陷；而带外管理是设备为管理控制提供了专门的带宽，不占用设备的原有网络资源，不依托于设备自身的操作系统和网络接。

#### 包转发速率

https://www.cnblogs.com/liushui-sky/p/14303485.html

交换机的包转发率（吞吐量|包转发能力）指的是交换机转发数据包的能力，单位是pps（包每秒)，也就是交换机每秒可以转发多少个数据包。—— 注所有端口的转发能力总和才是交换机的包转发率

转发能力以能够处理最小包长来衡量，对于以太网最小包为**64Byte**（**由于以太网的冲突检测机制，所以以太网传输数据帧时对数据帧的大小有个限制，数据帧最小为64byte**），加上帧开销**20Byte**（**在以太网中，每个帧头都要加上了8个字节的前导符，前导符的作用在于告诉监听设备数据将要到来。然后，以太网中的每个帧之间都要有帧间隙，即发完一个帧之后要等待一段时间再发另外一个帧，在以太网标准中规定最小是12个字节，然而帧间隙在实际应用中有可能会比12个字节要大，在这里我用了最小值。每个帧都要有20个字节的固定开销**），因此最小包为**84Byte**。

交换机接口速率：100Mbit/s的以太网接口，学过计算机的同学都知道，每8个bit组成一个字节，所以接一个百兆接口转换成节=12.5Mbyte/s，也就是说每秒这个以太网接口能转发12.5M个字节=12500000byte。以此百兆以太口为例，一个百兆以太口每秒最多转发12500000byte的数据，假设在最糟糕的情况下所传输的所有数据帧都是最小的84byte（当然如果传输的数据帧越大对交换机转发越有利，所以我们这里假设一个极端，在最糟糕的情况下），那么这个百兆以太口每秒转发的数据帧为 12500000/84=148809pps(帧/秒或包每秒)=148.8kpps=0.1488Mpps。

**——注：1000000K= 1000M=1G**

交换机线性无阻塞传输计算公式：

A、每种端口的速率 X 端口数量之和的2倍应该小于背板带宽，可实现全双工无阻塞交换，证明交换机具有发挥最大数据交换性能的条件。

B、满配置吞吐量(Mpps)=满配置GE端口数×1.488Mpps，其中1个千兆端口在包长为64字节时的理论吞吐量为1.488Mpps。例如，一台最多可以提供64个千兆端口的交换机，其满配置吞吐量应达到 64×1.488Mpps = 95.2Mpps，才能够确保在所有端口均线速工作时，提供无阻塞的包交换。

举例：如果一台交换机最多能够提供176个千兆端口，而宣称的吞吐量为不到261.8Mpps(176 x 1.488Mpps = 261.8)，那么用户有理由认为该交换机采用的是有阻塞的结构设计。

* 对于万兆以太网，一个线速端口的包转发率为14.88Mpps。 
* 对于千兆以太网，一个线速端口的包转发率为1.488Mpps。

#### 端口/链路聚合: Link Aggregation

端口聚合 和 链路聚合是一个东西--

链路聚合是将两个或更多数据信道结合成一个单个的信道，该信道以一个单个的更高带宽的逻辑链路出现。

链路聚合一般用来连接一个或多个带宽需求大的设备，例如连接骨干网络的服务器或服务器群。它可以用于扩展链路带宽，提供更高的连接可靠性。

端口聚合生成single logical link，不会造成环路，可作为Access Port（连接主机）或Trunk Port（承载Multi-VLAN traffic）使用。

**端口汇聚**是将多个端口聚合在一起形成1 个汇聚组，以实现出/入负荷在各成员端口中的分担，同时也提供了更高的连接可靠性。端口汇聚可以分为手工汇聚、动态LACP 汇聚和静态LACP 汇聚。同一个汇聚组中端口的基本配置应该保持一致，即如果某端口为Trunk 端口，则其他端口也配置为Trunk 端口;如该端口的链路类型改为Access 端口，则其他端口的链路类型也改为Access 端口。

 不同厂商交换机的端口聚合（Port Aggregation，PA）采用不同术语，Cisco的EtherChannel，Brocade的Brocade LAG，还有基于标准的IEEE 802.3ad LACP（Link Aggregation Control Protocol，该标准在2008年被转入IEEE 802.1ax），LACP可以动态配置端口聚合，且不依赖任何厂商，因此大部分以太网交换机都支持该协议。



端口聚合也叫做以太通道（ethernet channel），主要用于交换机之间连接。使用以太通道的话，交换机会把一组物理端口联合起来，做为一个逻辑的通道，也就是channel－group，这样交换机会认为这个逻辑通道为一个端口。

这样有几个优点: 

1. 带宽增加，带宽相当于组成组的端口的带宽总和。
2. 增加冗余，只要组内不是所有的端口都down掉，两个交换机之间仍然可以继续通信。
3. 负载均衡，可以在组内的端口上配置，使流量可以在这些端口上自动进行负载均衡

由于两个交换机之间有多条冗余链路的时候，STP会将其中的几条链路关闭，只保留一条，这样可以避免二层的环路产生。但是，失去了路径冗余（无法实现负载均衡--）的优点，因为STP的链路切换会很慢，在50s左右。



##### 应用例子

公司有2层楼，分别运行着不同的业务，本来两个楼层的网络是分开的，但都是一家公司难免会有业务往来，这时我们就可以打通两楼之前的网络，使具有相互联系的部门之间高速通信

![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/switch-Link-Aggregation.jpg)

如上图所示，SwitchA和SwitchB通过以太链路分别都连接VLAN10和VLAN20的网络，且SwitchA和SwitchB之间有较大的数据流量。

用户希望SwitchA和SwitchB之间能够提供较大的链路带宽来使相同VLAN间互相通信。同时用户也希望能够提供一定的冗余度，保证数据传输和链路的可靠性。

创建EtherChannel接口并加入成员接口，实现增加链路带宽，2台交换机分别配置EtherChannel1 分别将需要通信的3条线路的端口加入EtherChannel1，设置端口trunk， 允许相应的vlan通过;这样两楼的网络就可以正常通信了。



#### 冗余链路： mark

为了保持网络的稳定性，在多台交换机组成的网络环境中，通常都使用一些备份连接，以提高网络的效率、稳定性，这里的备份连接也称为备份链路或者冗余链路。

在骨干网设备连接中,单一链路的连接很容易实现,但一个简单的故障就会造成网络的中断.因此在实际网络组建的过程中,为了保持网络的稳定性,在多台交换机组成的网络环境中,通常都使用一些备份连接,以提高网络的健壮性、稳定性.

这里的备份连接也称为备份链路或者冗余链路.备份链路之间的交换机经常互相连接,形成一个环路,通过**环路**可以在一定程度上实现冗余。

由于公司对网络的可靠性的要求，大部分公司都会增加额外的交换机，防止在某台交换机出现故障时造成网络的无法使用的情况，例如形成如下图的拓扑的结构。

假设 X 和 Y 交换中的一台出现故障后，流量依然可以到达 B。

![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/switch-redundant.png)

虽然说这样的结构可以很好的解决，网络可靠性的问题。但由于这四台交换机构成了一个环路，同时也带了一些额外的问题：

1、广播风暴:

这里假设 W 不知道 B 的 MAC 地址，会采用泛洪的操作。而此时由于环状的结构，广播数据包会在四台交换机之间来回的传输，占用大量的带宽。

2、多帧拷贝：

假设 W 不知道 B 的 MAC 地址，此时会泛洪发给 Y 和 X，假设 Y 和 X 知道 B 的 MAC 地址，此时会将数据包以单播的形式发给 Z，而 Z 会将两个单播数据包传给 B. 造成传输冗余的数据帧。

3、MAC 表不稳定：

同样假设 W 不知道 B 的 MAC，采用泛洪。同时 X，Y，Z 也不知道 B 的 MAC。此时 W 广播后，X 和 Y 会在 MAC 表中记录 A 对应 MAC 在 1 号口，然后继续泛洪给 Z. Z 按照时间顺序假设在 MAC 表中记录的是来自 Y 的数据帧，此时记录的是 2 号口。而由于 Z 也不知道 B 的 MAC，还会广播。此时 Y 和 X 也会收到，此时 MAC 表按照时间顺序，又会改为另一个 2 号口，进而在 1 和 2 口之间来回抖动。

#### 解决交换机环路

##### 冷备份

在连接线缆时，仅仅连接一条线路。当这条链路出现问题时，由管理员手动切换至另一根线路。

##### 热备份

线缆正常连接，在接口上进行配置，不允许该接口接受和发送任何设备。通过 STP （生成树）实现。

##### STP 解决环路

STP： Spanning Tree Protocol

 STP 技术在逻辑上将某些接口阻塞掉，防止形成环路。

![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/stp-pro.jpg)

端口角色描述--

根端口RP	能够转发数据，接收BPDU（存储最优的BPDU），通常不发BPDU

指定端口DP	能够转发数据，接收BPDU（发送RP收到的最优BPDU），通常不收BPDU
阻塞端口Block	不能转发数据，接收BPDU（存储RP以外的次级BPDU），不发BPDU
Disable	不参与STP，不转发任何数据和BPDU

STP 选举规则 – 802.1D

在所有设备启动时，所有交换机都认为自己是跟，然后广播发送 BPDU，然后在 BPDU 中的某些参数选择一个真正的树根。

1、 在整个拓扑上，选择一台根交换机。
2、 对每台非根交换机上，选择一个根端口（RP）。
3、 在每条网线上（每个网络），选一个指定端口(DP)。
4、 余下端口为 BP，被阻塞的端口。

BPDU 比较参数，按照如下的顺序进行比较:

1、 根桥 ID（优先级，根的 MC 地址）
2、 COST（发送者桥 ID 到根桥的距离）
3、 发送者桥 ID（优先级，桥 MAC 地址）
4、 发送者端口 ID（接口号）

STP状态

- Disabled: 禁用状态，STP 协议未开启，或端口未打开。
- Blocking: 阻塞状态，不能转发数据，但可以收 BPDU.
- Listening: 确定端口角色。
- Learning：学习 MAC 地址，建立 MAC 表。
- Forwarding： 转发状态。

在交换机接口打开时，进入到 Listening 状态，进行 STP 的计算，需要等待 15s 转发延时。在选举时，无法转发数据。

当 Listening 状态结束后，进入 Learning 状态，学习 MAC 地址，建立 MAC 地址表，需要等待 15s 转发延时。

之后进入 Forwarding 状态，正常转发数据。

如果是被 STP 阻塞的端口进入 Blocking 状态，不能转发数据，但可以接受 BPDU. 当在 20s 内没有收到 BPDU 时，会进入 Forwarding 状态，开始转发数据。



###### **例子 1**

以下拓扑为例，模拟下选择 BPDU 的过程，假设 MAC 地址大小为：SW1 < SW2 < SW2.

![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/sfp-1.png)



首先判断根桥 ID，如果没有配置过，默认都是一样的。接着会比较 MAC 地址，选出最小的 MAC 作为根桥, 也就是 SW1.

在选出根后，根会每 2s 发送一次 BPDU，然后非根交换机转发 BPDU。

比较 COST，SW1 作为根会向 SW2 和 SW3 转发 BPDU，而 SW2 和 SW3 同时也会转发收到的 BPDU 给对方。这里假设都是百兆链路。

这里以 SW2 为视角，会收到 SW1 发送的 BPDU 和 SW3 转发 SW3 的 BPDU. 对于 SW2 的 1 号接口来说 COST 为 0（发送者为 SW1，跟桥 ID 为 SW1），对于 2 号口来说，COST 为 19（发送者 SW3，根桥 ID 为 SW1）.

> 100 M -> COST = 19
>
> 10 M -> COST = 100

进而 0 小于 19，1 号口为成为 RP.

同理，在 SW3 的视角，收到 SW1 和 SW2 转发 SW1 的BPDU. 选择 2 号口为 RP.

下面接着选择 DP：

先站在 SW1 和 SW2 这条网段的视角，在该网段可以接收道 SW1 直接发送的 BPDU （记为 SW1 1 号口）和 经过 SW2 和 SW3 转发过来的 BPDU（记为 SW2 1号口）. 这里比较下两者的 BPDU.

1、 首先比较根桥 ID，都是 SW1，一样，继续比较。
2、 比较 COST，

```
 *  SW1 1 号口，根桥 ID 和 发送者 ID 都是 SW1，所以 COST 为 0
 *  SW2 1 号口，根桥 ID 为 SW1，发送者为 SW3, 经过 SW2. 所以 COST=19 +19=38
 *  0 < 19 , SW1 1 号口为成为 DP.
```

站在 SW1 和 SW3 这段网络上，同理：

1、 首先比较根桥 ID，都是 SW1，一样，继续比较。
2、 比较 COST:

```
 *  SW1 2 号口，根桥 ID 和 发送者 ID 都是 SW1，所以 COST 为 0
 *  SW3 2 号口，根桥 ID 为 SW1，发送者为 SW2, 经过 SW3. 所以 COST=19 +19=38
 *  0 < 19, SW3 2 号口为 DP.
```

最后站在 SW2 和 SW3 这条网段上：

1、 首先比较根桥 ID，都是 SW1，一样，继续比较。
2、 比较 COST：

```
 *  SW2 2 号口，发送者为 SW2 2 号口，根桥 ID 为 SW1 COST = 19
 *  SW3 1 号口，发送者为 SW3 1 号口，根桥 ID 为 SW1 COST = 19
 *  相等继续比较。
```

3、 比较发送者桥 ID 大小：

```
 *  SW2 的 MAC 小于 SW3 的 MAC
 *  所以选 SW2 的 2 号口为 DP.
```

最终，余下接口 SW3 的 1 号口为阻塞接口。

总结一下概念：

RP：到根交换机最近的非根交换机接口

DP：在交换机中的连线上，到达根交换机最近的接口

###### STP缺点

缺点：

0、STP性能问题，只能支持小于50个设备、

1、拓扑收敛慢，当网络拓扑发生改变的时候，生成树协议需要50-52秒的时间才能完成拓扑收敛。
2、不能提供负载均衡的功能。当网络中出现环路的时候，生成树协议简单的将环路进行Block，这样该链路就不能进行数据包的转发，浪费网络资源。



###### 华为交换机配置链路冗余

https://www.cxyzjd.com/article/qq_43640414/86043361

目标：



实验步骤：

VRRP虚拟路由冗余协议

1、在同一网段内实现网关设备备份
2、PC设置为网关地址为虚拟路由器IP地址

3、STP阻塞端口，消除环路

![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/switch-redundant-link.png)



#### 堆叠技术: Stack/H3C IRF

核心：堆叠还可以避免环路问题。

堆叠是指将多台支持堆叠特性的交换机通过堆叠线缆连接在一起，从逻辑上虚拟成一台交换设备，作为一个整体参与数据转发。堆叠是目前广泛应用的一种横向虚拟化技术，具有提高可靠性、扩展端口数量、增大带宽、简化组网等作用。

交换机采用堆叠形式组网，分别组成管理网络、业务网络和存储网络，可采用10GE或25GE进行组网。带外管理交换机主要负责在服务器宕机、管理网失效场景下进行应急管理，可采用较低配置的电口交换机。

**叠加的交换机之间通过两条环路连接起来。交换机的硬件负责将数据包在双环路上做负载均衡。**

目前各大网络厂商分别拥有各自的交换机堆叠技术，比如华为的iStack（Intelligent Stack）和CSS、华三的IRF（Intelligent Resilient Framework，智能弹性架构）以及思科的StackWise等等。

H3C IRF 是这个啊。

![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/switch-stack.jpg)

![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/switch-stack-pro.jpg)

##### 堆叠实际应用：6

堆叠对百分之90的公司都是极好的方案，考虑堆叠是厂家黑盒问题多，但完全可以把堆叠下沉到接入层，上层全跑路由。



第一次使用堆叠是2008年，一个500人左右公司企业网，Cisco 29xx，公司位于同一楼层，机房就一个，4个堆叠成一个逻辑交换机（逻辑整体），一共创建了3个这样的逻辑交换机，用了12台交换机。

如果不是系统对堆叠成员个数的限制、堆叠线长度的限制、以及一个机架容纳交换机个数的空间限制，完全可以将12台交换机堆叠成一个交换机。

**堆叠好处主要有：**

**1）管理负担小**

管理1台交换机自然比管理多台交换机的负担小，还可以避免配置成员交换机之间port channel等配置。

**2）节省交换机互联端口的数目**

成员交换机之间的数据传输，使用堆叠线，堆叠线可以看作交换机内部数据总线的外部延伸，这样可以节省互联端口的需求。

**3）外在表现为一台交换机**，可以使用常规的LACP协议与服务器协商Port Channel，而无需使用VPC或MLAG等私有协议，让服务器与跨交换机的端口协商Port Channel。

**4）由于是私有实现，具有排他性，可以更好地排挤竞争对手。**

堆叠成员交换机之间的数据同步、用户流量传输，通常使用堆叠线，而**堆叠线是内部数据总线的延伸**，所以数据是如何同步的、流量如何传输的，完全是厂商的自我实现，这就好比一台交换机内部的流量如何传输，什么格式传输都是私有实现，一旦出问题，用户看到奇奇怪怪的trace log报警输出，会一脸懵逼。

**黑盒，出了问题叫厂家，这对甩锅型运维团队是极好的。**

> 类似Oracle的专业维护团队--

###### 扩展端口数量

当接入的用户数增加到原交换机端口密度不能满足接入需求时，可以通过增加新的交换机并组成堆叠而得到满足。

![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/switch-stack-1.png)

###### 扩展带宽

当交换机上行带宽增加时，可以增加新交换机与原交换机组成堆叠系统，将成员交换机的多条物理链路配置成一个聚合组，提高交换机的上行带宽。

![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/switch-stack-2.png)

###### 提高可靠性

叠与Eth-Trunk一同使用，当堆叠系统中一台设备的上行链路故障，通过该设备的流量可经过堆叠链路进行转发。

![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/switch-stack-3.png)





##### 跳线

光纤跳线（又称**光纤连接器**），也就是接入光模块的**光纤**接头，也有好多种，且相互之间不可以互用。SFP模块接LC光纤连接器，而GBIC接的是SC光纤连接器。

交换机堆叠配置步骤如下：

1、断电的情况下，通过DAC/AOC高速线缆或者光模块、跳线完成交换机的堆叠连接。注意：堆叠交换机的数量不应该超过最大堆叠交换机数量。

2、依次开电，完成交换机的堆叠配置。

3、所有交换机配置完成后，交换机重启，分配每个堆栈成员的角色。

4、重启完成后，只有主堆叠交换机具有配置权限，检查接口信息，主交换机将显示所有接口。

##### 单板

单板就是电路板（交换机或服务器都会用的）吧。

单板加工很复杂，需要把电阻、电容、晶体管、集成电路等安装到一块空白的印刷电路板上。

单板，是交换机处理各种数据报文重要的模块单元，是核心单元，按照功能的不同，包括主控板、交换网板、接口板、监控板等。主控板负责系统的控制、管理和监控工作；交换网板负责系统数据平面的数据线速交换；接口板负责系统数据包的处理和流量管理；监控板，早期主控板没有集成监控功能时，由监控板独立负责系统的监控工作。

下面就是高端交换机的管理板，包括了控制口serial等

![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/交换机管理板.jpg)

###### PCB

在印制电路板出现之前，电子元件之间的互连都是依靠电线直接连接而组成完整的线路，为了减少电子零件间的配线，降低制作成本才研制了PCB板。

**印刷电路板**，又称**印制电路板**，**印刷线路板**，常用英文缩写**PCB**（Printed circuit board）或**PWB**（Printed wire board），是电子元件的支撑体，在这其中有金属导体作为连接电子元器件的线路。

传统的电路板，采用印刷蚀刻阻剂的工法，做出电路的线路及图面，因此被称为印刷电路板或印刷线路板。由于电子产品不断微小化跟精细化，目前大多数的电路板都是采用贴附蚀刻阻剂（压膜或涂布），经过曝光显影后，再以蚀刻做出电路板。



###### 集成电路

集成电路是一般是指芯片的集成，像主板上的北桥芯片，CPU内部，都是叫集成电路，原始名也是叫集成块的。而PCB是指我们通常看到的电路板，还有在电路板上印刷焊接芯片。

对于两者关系的理解： **集成电路（IC）是焊接在PCB板上的；PCB板是集成电路（IC）的载体。**

简单来说，集成电路是把一个通用电路集成到一块芯片上，它是一个整体，一旦它内部有损坏，那这个芯片也就损坏了，而PCB是可以自己焊接元件的，坏了可以换元件。



#### M-LAG：mark

M-LAG（Multichassis Link Aggregation Group）即跨设备链路聚合组，是一种实现跨设备链路聚合的机制。如图所示，将两台交换机通过peer-link链路连接并以同一个状态和主机进行链路聚合协商，从而把链路可靠性从**单板**级提高到了设备级。

![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/switch-mlag-1.png)

##### 负载分担

M-LAG双活系统在接入设备双归接入场景下，接入设备通过Eth-Trunk的方式接入到M-LAG设备组，M-LAG的成员设备接收到接入设备通过链路捆绑负载分担发送的流量后，共同进行流量转发。

![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/switch-mlag-2.png)

##### 提高可靠性

M-LAG接入普通以太网场景，由于M-LAG主设备的上行链路故障，通过M-LAG主设备的流量均经过peer-link链路进行转发。

![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/switch-mlag-3.png)



##### mlag and stack

M-LAG与堆叠的区别

|                   | 堆叠                                                         | M-LAG                                                        |
| ----------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| **虚拟系统的IP**  | 堆叠设备组有统一的IP地址。堆叠生效后各成员自己的IP地址失效。 | M-LAG设备组成员有各自的IP地址。M-LAG设备组没有统一的IP地址。 |
| **虚拟系统的MAC** | 堆叠设备组有统一的MAC地址。堆叠生效后各成员自己的MAC地址失效。 | M-LAG设备组成员有各自的MAC地址。M-LAG设备组没有统一的MAC地址。 |
| **设备登录**      | 所有设备相当于一台设备，登录设备组中任意一台设备均相当登录主设备。 | 所有设备独立，各设备仍有独立的管理网口。                     |
| **双主检测链路**  | 业务口直连Eth-Trunk口代理管理网口检测                        | 三层可达的链路                                               |
| **状态协商**      | 通过iStack链路传递报文。                                     | 通过peer-link链路传递Hello报文、设备信息报文。               |
| **可检测的故障**  | 直连链路故障堆叠系统成员设备故障iStack链路故障堆叠端口故障   | 直连链路故障M-LAG成员设备故障Peer-link链路故障接口故障       |

堆叠、M-LAG优劣势对比

|                  | 堆叠                                                         | M-LAG                                                        |
| ---------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| **可靠性**       | 一般：控制面集中，故障可能在成员设备上扩散。主设备的故障可能影响成员设备，可靠性一般。 | 较高：控制面独立，故障域隔离。                               |
| **成本**         | 一般：需部署堆叠线缆。                                       | 一般：需部署Peer-link线缆。                                  |
| **配置复杂度**   | 简单：逻辑上为一台设备，多台设备同时配置。                   | 正常：多台设备独立配置。                                     |
| **扩展能力**     | 一般：控制面的能力局限于主设备的能力。                       | 较强：扩展能力不受单台设备限制。                             |
| **对业务的影响** | 升级：业务20秒~1分钟的中断。扩容：三台设备以上扩容时需改变原有网络架构或重启设备，影响现有业务。 | 升级：流量秒级中断。扩容：不改变原有网络架构，不影响现有业务。 |
| **升级复杂度**   | 高：通过堆叠快速升级可以降低业务中断时间，但升级操作时间变长，升级风险变高。 | 低：通过reboot升级，操作简单，风险低。                       |
| **网络设计**     | 相对简单：逻辑上单节点设计。                                 | 相对复杂：逻辑上双节点设计。                                 |

总的来说，堆叠具有配置、设计相对简单的优点，但灵活度、可靠性、升级复杂程度均不如M-LAG；M-LAG相比于堆叠虽然配置复杂度较高，但其控制面解耦、组网灵活度高的特点使其可靠性更强。

#### 冗余 and 堆叠应用：mark

IRF是Intelligent Resilient Framework的简称，即智能弹性架构，是H3C公司专有的设备虚拟化技术，将实际物理设备虚拟化为逻辑设备供用户使用。

如下：

链路冗余 + 交换机堆叠

![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/switch-stack-and-redundant-2.jpg)

更高级的应用：

**叠加的交换机之间通过两条环路连接起来。交换机的硬件负责将数据包在双环路上做负载均衡。**







#### DRNI：对标聚合？

两台设备的控制平面分离，可靠性更高。但是由于控制平面分离就会导致一份配置需要在两个设备上都分别执行。

普通聚合的链路只能够在一台设备上，只能提供链路级的保护，当设备故障以后，普通聚合将无法工作，所以需要设备级保护的技术。

DRNI（Distributed Resilient Network Interconnect，分布式弹性网络互连）作为一种跨设备链路聚合的技术，除了具备增加带宽、提高链路可靠性、负载分担的优势外，还具备以下优势：

1.  更高的可靠性: 把链路可靠性从单板级提高到了设备级。

2.  简化组网及配置：提供了一个没有环路的二层拓扑，同时实现冗余备份，不再需要繁琐的生成树协议配置，极大地简化了组网及配置。

3. 独立升级：两台设备可以分别进行升级，保证有一台设备正常工作即可，对正在运行的业务几乎没有影响。

DRNI主要应用于双归接入组网，将可靠性从链路级提高到设备级。

##### DRNI 应用

DRNI将两台物理设备虚拟成一台设备来实现跨设备链路聚合，从而提供设备级**冗余保护**和**流量负载分担**。

DRNI主要应用于双归接入组网，将可靠性从链路级提高到设备级。

这里，服务网卡可以做bond接两个交换机的网线，实现网络高可用。

![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/DRNI-1.png)

> “注：IPL用于DRCP报文的交互和数据报文的传输。

DRNI系统中的接口、链路或者设备发生故障时，可将用户流量切换到正常设备/链路转发，确保用户**业务不中断**。

![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/DRNI-2.png)

###### **多级DRNI互联**

多级DRNI互联在提高可靠性、链路利用率的同时，扩展了双归属接入的网络规模，为服务器数量较多的大二层数据中心网络提供稳定网络环境。

![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/DRNI-3.png)



###### **DRNI+VRRP**

在汇聚层设备上部署DRNI，实现流量的负载分担，同时保证高可靠性。

在汇聚层设备上部署VRRP，为服务器提供冗余备份的网关，保证服务器流量不中断。

![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/DRNI-4.png)



###### **DRNI+EVPN**

EVPN采用DRNI技术将虚拟出的设备作为VTEP，**简化了VTEP的配置和管理**。

服务器通过DRNI双归接入EVPN网络，实现流量负载分担和链路备份。

![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/DRNI-5.png)





#### 交换机协议



### 10G/40G and 25G/100G

以太网接口的传输速率在过去几十年来大体呈线性增长(每10年增长10倍)。大家的台式电脑或笔记本电脑的有线网卡基本是千兆网卡。而在当前的许多数据中心中，服务器的接口是10Gbps（万兆）, 交换机间的接口是40Gbps（四万兆），它们中的大多数都在考虑（或者正在）将网络升级到下一代的25G/100G网络（服务器的接口是25Gbps, 交换机间互联的接口是100Gbps）。

一个100Gbps连接可被分接线缆（Break-out Cable）分解为四个通道（每个通道25Gbps），所以100G网络有时被称为25G/100G网络。同理,10G网络有时也被称为10G/40G网络。

![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/switch-10-40-0.png)



#### 10G/40G

\1. Spine交换机和Leaf (TOR)交换机之间链路为40Gbps。

\2. 服务器接口为10Gbps，不同的Leaf交换机提供10G接口的方式及端口密度可能并不一样。

* 1)以某Leaf交换机为例，该交换机端口规格为：48\*10Gbps+6\*40Gbps ，此时Leaf 交换机提供的10G接口是Leaf交换机的原生10G接口：

  ![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/switch-10-40-1.png)

* 2)以某Leaf交换机为例，该交换机端口规格为：32\*40Gbps，此时该Leaf 交换机提供的10G接口是其原生的40G接口经一分四Break-out cable分接出来的(在6个端口用于上连Spine交换机的场景下，能提供(32-6)\*4=104个10G端口)：

  ![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/switch-10-40-2.png)

  ![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/switch-10-40-3.png)

  

#### 25G/100G

Spine交换机和Leaf 交换机之间链路为100Gbps

服务器接口为25Gbps不同的Leaf交换机提供25G接口的方式及端口密度可能并不一样：

* 1）以某Leaf交换机为例，该交换机端口规格为：48\*25Gbps+6\*100Gbps ，此时Leaf 交换机提供的25G接口是Leaf交换机的原生25G接口：

  ![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/switch-10-40-1.png)

* 2）以某Leaf交换机为例，该交换机端口规格为：32*100Gbps，此时该Leaf 交换机提供的25G接口是其原生的100G接口经一分四Break-out cable分接出来的（在6个端口用于上连Spine交换机的场景下，能提供（32-6）4=104个25G端口）：

  ![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/switch-10-40-2.png)

  ![](https://image-1300760561.cos.ap-beijing.myqcloud.com/bgyq-blog/switch-10-40-4.png)

  

  



### Port

#### Trunk

如果没有VLAN中继（Trunk），假设两台交换机上分别创建了多个VLAN（VLAN是基于Layer 2的），在两台交换机上相同的VLAN（比如VLAN10）要通信，则需要将交换机A上属于VLAN10的一个端口与交换机B上属于VLAN10的一个端口互连；如果这两台交换机上其它相同VLAN间也需要通信（例如VLAN20、VLAN30），那么就需要在两个交换机之间VLAN20的端口互连，而划分到VLAN30的端口也需要互连，这样不同的交换机之间需要更多的互连线，端口利用率就太低了。

交换机通过trunk功能，事情就简单了，只需要两台交换机之间有一条互连线，将互连线的两个端口设置为trunk模式，这样就可以使交换机上不同VLAN共享这条线路。



```bash
[SW1] interface gigabitEthernet0/0/24
[SW1-GigabitEthernet0/0/24] port link-type trunk
[SW1-GigabitEthernet0/0/24] port trunk allow-pass vlan 10 20
```

由于VLAN Trunk可以传输多个VLAN数据，Ethernet Frame在VLAN Trunk上传输时，需要带上802.1Q定义的VLAN tag，这样交换机才能区分Ethernet Frame到底属于哪个VLAN。VLAN Trunk的具体使用过程如下：

◆    当最左侧服务器想要访问最右侧服务器，最左侧服务器将Ethernet Frame发送到左侧交换机

◆    左侧交换机本地没有目的MAC对应的转发信息，因此Ethernet Frame发送到了左侧交换机的VLAN Trunk port

◆    由于这是来自VLAN100的Ethernet Frame，交换机给Ethernet Frame打上VLAN 100的Tag，从自己的VLAN Trunk port发出，发送到右侧交换机的VLAN Trunk port

◆    右侧的VLAN Trunk port收到VLAN 100的Ethernet Frame，去除VLAN Tag，再在本地的VLAN 100端口中查找MAC转发

◆    找到对应的MAC/端口记录，最终Ethernet Frame发送到最右侧的服务器

优点

1.可以在不同的交换机之间连接多个VLAN，可以将VLAN扩展到整个网络中；

2.Trunk可以捆绑任何相关的端口，也可以随时取消设置，这样提供了很高的灵活性；

3.Trunk可以提供负载均衡能力以及系统容错。由于Trunk实时平衡各个交换机端口和服务器接口的流量，一旦某个端口出现故障，它会自动把故障端口从Trunk组中撤消，进而重新分配各个Trunk端口的流量，从而实现系统容错；

#### Channel

？

### 引用

1. https://www.sdnlab.com/21166.html
2. https://tech.souyunku.com/?p=44976
3. https://www.cxyzjd.com/article/qq_43640414/86043361
4. https://blog.51cto.com/liushuai/829378
5. https://network.51cto.com/article/603423.html
6. https://www.zhihu.com/question/264188247/answer/281626808
7. https://cloud.tencent.com/developer/article/1632621
8. https://support.huawei.com/enterprise/zh/doc/EDOC1100170402#ZH-CN_TOPIC_0291964546
9. https://zhuanlan.zhihu.com/p/64455461
